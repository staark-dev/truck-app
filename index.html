<!DOCTYPE html>

<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program »òofer Camion - Suedia</title>
    <meta name="theme-color" content="#1f2937">
    <meta name="description" content="Aplica»õie PWA pentru gestionarea programului de lucru conform reglementƒÉrilor din Suedia">

```
<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192' fill='%23fbbf24'%3E%3Crect x='24' y='60' width='144' height='72' rx='12' fill='%23374151'/%3E%3Crect x='36' y='48' width='120' height='24' rx='6' fill='%23fbbf24'/%3E%3Ccircle cx='54' cy='150' r='18' fill='%23374151'/%3E%3Ccircle cx='138' cy='150' r='18' fill='%23374151'/%3E%3Ccircle cx='54' cy='150' r='9' fill='%23fbbf24'/%3E%3Ccircle cx='138' cy='150' r='9' fill='%23fbbf24'/%3E%3Cpath d='M72 72h48v24H72z' fill='%2393c5fd'/%3E%3C/svg%3E">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        color: white;
        min-height: 100vh;
        padding: 10px;
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
    }

    .container {
        max-width: 420px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
        text-align: center;
        margin-bottom: 25px;
    }

    .header h1 {
        font-size: 22px;
        margin-bottom: 8px;
        color: #fbbf24;
    }

    .header p {
        font-size: 14px;
        color: #d1d5db;
    }

    .nav-tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 20px;
        padding: 4px;
    }

    .nav-tab {
        flex: 1;
        padding: 12px 8px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
        border: none;
        background: none;
        color: #d1d5db;
    }

    .nav-tab.active {
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .status {
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .status.working {
        background: rgba(34, 197, 94, 0.2);
        border-color: #22c55e;
    }

    .status.resting {
        background: rgba(251, 191, 36, 0.2);
        border-color: #fbbf24;
    }

    .status.idle {
        background: rgba(156, 163, 175, 0.2);
        border-color: #9ca3af;
    }

    .timer {
        font-size: 28px;
        font-weight: bold;
        margin: 12px 0;
        font-family: 'Courier New', monospace;
    }

    .buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }

    .btn {
        padding: 15px 12px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        outline: none;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .btn-start {
        background: linear-gradient(45deg, #22c55e, #16a34a);
        color: white;
        grid-column: 1 / -1;
    }

    .btn-break {
        background: linear-gradient(45deg, #fbbf24, #f59e0b);
        color: white;
    }

    .btn-stop {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .next-break {
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #fbbf24;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: #d1d5db;
    }

    .weekly-summary {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .history-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 4px solid #22c55e;
    }

    .history-item .time {
        font-weight: bold;
        color: #fbbf24;
        font-size: 14px;
    }

    .history-item .duration {
        font-size: 12px;
        color: #d1d5db;
        margin-top: 4px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 300px;
    }

    .export-btn {
        background: linear-gradient(45deg, #8b5cf6, #7c3aed);
        color: white;
        width: 100%;
        margin-top: 15px;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .regulation-info {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 13px;
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 15px;
        color: #fca5a5;
        font-size: 13px;
        display: none;
    }

    @media (max-width: 480px) {
        .container {
            margin: 5px;
            padding: 20px;
        }
        
        .timer {
            font-size: 24px;
        }
        
        .nav-tab {
            font-size: 12px;
            padding: 10px 6px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ Program »òofer Camion</h1>
            <p>ReglementƒÉri Suedia | Timp de lucru EU</p>
        </div>

```
    <div class="error-message" id="errorMessage">
        ‚ö†Ô∏è A apƒÉrut o problemƒÉ. Aplica»õia va reporni automat.
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="timer">‚è±Ô∏è Timer</button>
        <button class="nav-tab" data-tab="stats">üìä Statistici</button>
        <button class="nav-tab" data-tab="history">üìú Istoric</button>
        <button class="nav-tab" data-tab="settings">‚öôÔ∏è Export</button>
    </div>

    <!-- Timer Tab -->
    <div class="tab-content active" id="timer-tab">
        <div class="regulation-info">
            üá∏üá™ <strong>ReglementƒÉri Suedia:</strong> PauzƒÉ obligatorie de min. 30 min dupƒÉ 6h de lucru. Maxim 10h lucru/zi.
        </div>

        <div class="status idle" id="status">
            <div>üìç Status: <span id="statusText">Inactiv</span></div>
            <div class="timer" id="timer">00:00:00</div>
            <div id="sessionInfo"></div>
        </div>

        <div class="buttons">
            <button class="btn btn-start" id="startBtn">
                üöÄ √éncepe Programul
            </button>
            <button class="btn btn-break" id="breakBtn" disabled>
                ‚òï PauzƒÉ
            </button>
            <button class="btn btn-stop" id="stopBtn" disabled>
                üõë TerminƒÉ
            </button>
        </div>

        <div class="next-break" id="nextBreak" style="display: none;">
            <div>‚è∞ UrmƒÉtoarea pauzƒÉ obligatorie √Æn:</div>
            <div style="font-weight: bold; font-size: 18px; margin-top: 5px;" id="nextBreakTime">--:--:--</div>
        </div>
    </div>

    <!-- Stats Tab -->
    <div class="tab-content" id="stats-tab">
        <div class="weekly-summary">
            <h3 style="color: #3b82f6; margin-bottom: 10px;">üìÖ SƒÉptƒÉm√¢na curentƒÉ</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="weeklyHours">0h</div>
                    <div class="stat-label">Ore totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyDays">0</div>
                    <div class="stat-label">Zile lucrate</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="weeklyDriving">0h</div>
                    <div class="stat-label">Ore conducere</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weeklyBreaks">0</div>
                    <div class="stat-label">Pauze luate</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Sesiuni totale</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averageSession">0h</div>
                <div class="stat-label">Medie sesiune</div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content" id="history-tab">
        <h3 style="color: #fbbf24; margin-bottom: 15px;">üìä Istoric Sesiuni</h3>
        <div id="historyList">
            <p style="color: #9ca3af; text-align: center;">Nu existƒÉ sesiuni √Ænregistrate</p>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings-tab">
        <h3 style="color: #8b5cf6; margin-bottom: 15px;">‚öôÔ∏è Export & SetƒÉri</h3>
        
        <button class="btn export-btn" id="exportBtn">
            üìÅ ExportƒÉ date (JSON)
        </button>
        
        <button class="btn export-btn" id="exportCsvBtn">
            üìä ExportƒÉ CSV
        </button>
        
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button class="btn export-btn" id="importBtn">
            üìÇ ImportƒÉ date
        </button>
        
        <button class="btn export-btn" id="clearBtn" style="background: linear-gradient(45deg, #ef4444, #dc2626);">
            üóëÔ∏è »òterge toate datele
        </button>

        <div class="regulation-info" style="margin-top: 20px;">
            <strong>Backup recomandat:</strong><br>
            ExportƒÉ datele regulat pentru siguran»õƒÉ. Aplica»õia salveazƒÉ automat √Æn browser.
        </div>
    </div>
</div>

<script>
    // Prevent page reload on errors
    window.addEventListener('error', function(e) {
        console.error('JavaScript Error:', e.error);
        showError('Eroare JavaScript: ' + e.message);
        e.preventDefault();
    });

    window.addEventListener('unhandledrejection', function(e) {
        console.error('Promise Rejection:', e.reason);
        showError('Eroare Promise: ' + e.reason);
        e.preventDefault();
    });

    // Application state - stored in memory only initially
    let appState = {
        currentSession: null,
        isWorking: false,
        isOnBreak: false,
        startTime: null,
        breakStartTime: null,
        timer: null,
        sessions: [],
        currentTab: 'timer'
    };

    // Constants for Swedish regulations
    const BREAK_INTERVAL = 6 * 60 * 60 * 1000; // 6 hours
    const MIN_BREAK_TIME = 30 * 60 * 1000; // 30 minutes minimum break
    const MAX_DAILY_WORK = 10 * 60 * 60 * 1000; // 10 hours max per day

    // Safe localStorage wrapper
    const storage = {
        get: function(key) {
            try {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : null;
            } catch (e) {
                console.warn('LocalStorage read error:', e);
                return null;
            }
        },
        set: function(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.warn('LocalStorage write error:', e);
                return false;
            }
        },
        remove: function(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (e) {
                console.warn('LocalStorage remove error:', e);
                return false;
            }
        }
    };

    // DOM element cache
    const elements = {
        status: null,
        statusText: null,
        timer: null,
        sessionInfo: null,
        startBtn: null,
        breakBtn: null,
        stopBtn: null,
        nextBreak: null,
        nextBreakTime: null,
        errorMessage: null,
        navTabs: null
    };

    // Cache DOM elements
    function cacheElements() {
        elements.status = document.getElementById('status');
        elements.statusText = document.getElementById('statusText');
        elements.timer = document.getElementById('timer');
        elements.sessionInfo = document.getElementById('sessionInfo');
        elements.startBtn = document.getElementById('startBtn');
        elements.breakBtn = document.getElementById('breakBtn');
        elements.stopBtn = document.getElementById('stopBtn');
        elements.nextBreak = document.getElementById('nextBreak');
        elements.nextBreakTime = document.getElementById('nextBreakTime');
        elements.errorMessage = document.getElementById('errorMessage');
        elements.navTabs = document.querySelectorAll('.nav-tab');
    }

    // Utility functions
    function formatTime(milliseconds) {
        if (!milliseconds || milliseconds < 0) return '00:00:00';
        
        const hours = Math.floor(milliseconds / (1000 * 60 * 60));
        const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function formatHours(milliseconds) {
        if (!milliseconds || milliseconds < 0) return 0;
        return Math.round(milliseconds / (1000 * 60 * 60) * 10) / 10;
    }

    function showError(message) {
        if (elements.errorMessage) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            setTimeout(() => {
                if (elements.errorMessage) {
                    elements.errorMessage.style.display = 'none';
                }
            }, 5000);
        }
    }

    function showNotification(title, message, color = '#ef4444') {
        try {
            const notification = document.createElement('div');
            notification.className = 'notification pulse';
            notification.style.background = `linear-gradient(45deg, ${color}, ${color}dd)`;
            notification.innerHTML = `<strong>${title}</strong><br>${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 8000);

            return notification;
        } catch (e) {
            console.error('Notification error:', e);
        }
    }

    // Tab switching
    function switchTab(tabName) {
        try {
            // Update state
            appState.currentTab = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            elements.navTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const targetTab = document.getElementById(`${tabName}-tab`);
            const targetNavTab = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetNavTab) targetNavTab.classList.add('active');

            // Update data when switching to stats or history
            if (tabName === 'stats') {
                updateWeeklyStats();
            } else if (tabName === 'history') {
                updateHistory();
            }
            
            // Save state
            storage.set('currentTab', tabName);
        } catch (e) {
            console.error('Tab switch error:', e);
            showError('Eroare la schimbarea tab-ului');
        }
    }

    // Timer and work management
    function updateTimer() {
        try {
            if (!appState.isWorking && !appState.isOnBreak) return;

            const now = Date.now();
            let elapsed;

            if (appState.isOnBreak) {
                elapsed = now - appState.breakStartTime;
                if (elements.timer) elements.timer.textContent = formatTime(elapsed);
                if (elements.statusText) elements.statusText.textContent = '√én pauzƒÉ';
                if (elements.status) elements.status.className = 'status resting';
            } else if (appState.isWorking) {
                elapsed = now - appState.startTime;
                if (elements.timer) elements.timer.textContent = formatTime(elapsed);
                if (elements.statusText) elements.statusText.textContent = 'La volan';
                if (elements.status) elements.status.className = 'status working';

                // Update next break countdown
                const timeUntilBreak = BREAK_INTERVAL - (elapsed % BREAK_INTERVAL);
                if (elements.nextBreakTime) elements.nextBreakTime.textContent = formatTime(timeUntilBreak);

                // Check if break is needed
                if (timeUntilBreak <= 60000 && timeUntilBreak > 59000) {
                    showBreakWarning();
                } else if (elapsed > 0 && elapsed % BREAK_INTERVAL < 1000) {
                    showBreakNotification();
                }
            }

            if (elements.sessionInfo) {
                elements.sessionInfo.textContent = `Sesiunea curentƒÉ: ${formatTime(elapsed)}`;
            }
        } catch (e) {
            console.error('Timer update error:', e);
        }
    }

    function showBreakWarning() {
        showNotification('‚ö†Ô∏è Aten»õie!', 'Pauza obligatorie √Æn 1 minut!', '#fbbf24');
    }

    function showBreakNotification() {
        showNotification(
            'üõë PAUZƒÇ OBLIGATORIE!', 
            'Ai condus 6 ore consecutive. FƒÉ o pauzƒÉ de minim 30 minute conform reglementƒÉrilor din Suedia!',
            '#ef4444'
        );

        if (elements.breakBtn) elements.breakBtn.classList.add('pulse');

        // Browser notification
        if ('Notification' in window && Notification.permission === 'granted') {
            try {
                new Notification('PauzƒÉ Obligatorie - ReglementƒÉri Suedia!', {
                    body: 'Ai condus 6 ore consecutive. FƒÉ o pauzƒÉ de minim 30 minute!',
                    requireInteraction: true
                });
            } catch (e) {
                console.warn('Browser notification failed:', e);
            }
        }
    }

    function startWork() {
        try {
            appState.isWorking = true;
            appState.isOnBreak = false;
            appState.startTime = Date.now();
            appState.currentSession = {
                startTime: appState.startTime,
                date: new Date().toDateString(),
                breaks: []
            };

            // Update UI
            if (elements.startBtn) {
                elements.startBtn.disabled = true;
                elements.startBtn.textContent = 'üöÄ Pornit...';
            }
            if (elements.breakBtn) elements.breakBtn.disabled = false;
            if (elements.stopBtn) elements.stopBtn.disabled = false;
            if (elements.nextBreak) elements.nextBreak.style.display = 'block';

            // Start timer
            if (appState.timer) clearInterval(appState.timer);
            appState.timer = setInterval(updateTimer, 1000);
            updateTimer();

            // Save state
            saveAppState();
            
            console.log('Program √Ænceput la:', new Date(appState.startTime).toLocaleString());
        } catch (e) {
            console.error('Start work error:', e);
            showError('Eroare la pornirea programului');
        }
    }

    function startBreak() {
        try {
            if (!appState.isWorking) return;

            appState.isOnBreak = true;
            appState.breakStartTime = Date.now();
            
            appState.currentSession.breaks.push({
                start: appState.breakStartTime
            });

            // Update UI
            if (elements.breakBtn) {
                elements.breakBtn.disabled = true;
                elements.breakBtn.classList.remove('pulse');
            }
            if (elements.nextBreak) elements.nextBreak.style.display = 'none';

            if (elements.startBtn) {
                elements.startBtn.textContent = '‚ñ∂Ô∏è Reia Conducerea';
                elements.startBtn.disabled = false;
            }

            // Save state
            saveAppState();
            
            console.log('PauzƒÉ √ÆnceputƒÉ la:', new Date(appState.breakStartTime).toLocaleString());
        } catch (e) {
            console.error('Start break error:', e);
            showError('Eroare la √Ænceperea pauzei');
        }
    }

    function resumeWork() {
        try {
            if (!appState.isOnBreak) return;

            const breakDuration = Date.now() - appState.breakStartTime;
            
            // Check minimum break time
            if (breakDuration < MIN_BREAK_TIME) {
                const minutesNeeded = Math.ceil((MIN_BREAK_TIME - breakDuration) / 60000);
                alert(`Pauza trebuie sƒÉ fie de minim 30 minute conform reglementƒÉrilor din Suedia! Mai ai nevoie de ${minutesNeeded} minute.`);
                return;
            }

            // Record break end
            const currentBreak = appState.currentSession.breaks[appState.currentSession.breaks.length - 1];
            currentBreak.end = Date.now();
            currentBreak.duration = breakDuration;

            appState.isOnBreak = false;
            appState.breakStartTime = null;

            // Update UI
            if (elements.startBtn) {
                elements.startBtn.disabled = true;
                elements.startBtn.textContent = 'üöÄ Pornit...';
            }
            if (elements.breakBtn) elements.breakBtn.disabled = false;
            if (elements.nextBreak) elements.nextBreak.style.display = 'block';

            // Save state
            saveAppState();
            
            console.log('Conducerea reluatƒÉ dupƒÉ pauza de:', formatTime(breakDuration));
        } catch (e) {
            console.error('Resume work error:', e);
            showError('Eroare la reluarea conducerii');
        }
    }

    function stopWork() {
        try {
            if (!appState.isWorking) return;

            const endTime = Date.now();
            const totalDuration = endTime - appState.startTime;

            // Complete current session
            appState.currentSession.endTime = endTime;
            appState.currentSession.totalDuration = totalDuration;

            // If currently on break, end the break
            if (appState.isOnBreak && appState.currentSession.breaks.length > 0) {
                const currentBreak = appState.currentSession.breaks[appState.currentSession.breaks.length - 1];
                currentBreak.end = endTime;
                currentBreak.duration = endTime - appState.breakStartTime;
            }

            // Calculate driving time
            const totalBreakTime = appState.currentSession.breaks
                .filter(b => b.end)
                .reduce((sum, b) => sum + b.duration, 0);
            appState.currentSession.drivingTime = totalDuration - totalBreakTime;

            // Add to sessions
            appState.sessions.unshift(appState.currentSession);

            // Reset state
            appState.isWorking = false;
            appState.isOnBreak = false;
            appState.startTime = null;
            appState.breakStartTime = null;
            appState.currentSession = null;

            if (appState.timer) {
                clearInterval(appState.timer);
                appState.timer = null;
            }

            // Update UI
            if (elements.status) elements.status.className = 'status idle';
            if (elements.statusText) elements.statusText.textContent = 'Inactiv';
            if (elements.timer) elements.timer.textContent = '00:00:00';
            if (elements.sessionInfo) elements.sessionInfo.textContent = '';
            
            if (elements.startBtn) {
                elements.startBtn.disabled = false;
                elements.startBtn.textContent = 'üöÄ √éncepe Programul';
            }
            if (elements.breakBtn) {
                elements.breakBtn.disabled = true;
                elements.breakBtn.classList.remove('pulse');
            }
            if (elements.stopBtn) elements.stopBtn.disabled = true;
            if (elements.nextBreak) elements.nextBreak.style.display = 'none';

            // Save sessions
            saveSessions();
            
            // Clear app state
            storage.remove('appState');

            console.log('Program terminat. Durata totalƒÉ:', formatTime(totalDuration));
        } catch (e) {
            console.error('Stop work error:', e);
            showError('Eroare la terminarea programului');
        }
    }

    // State management
    function saveAppState() {
        try {
            const stateToSave = {
                ...appState,
                timer: null // Don't save the timer interval
            };
            storage.set('appState', stateToSave);
        } catch (e) {
            console.warn('Save app state error:', e);
        }
    }

    function loadAppState() {
        try {
            const savedState = storage.get('appState');
            if (savedState) {
                appState = { ...appState, ...savedState, timer: null };
                
                // Restore UI if working
                if (appState.isWorking || appState.isOnBreak) {
                    restoreWorkingState();
                }
            }
            
            const savedTab = storage.get('currentTab');
            if (savedTab) {
                appState.currentTab = savedTab;
            }
        } catch (e) {
            console.warn('Load app state error:', e);
        }
    }

    function restoreWorkingState() {
        try {
            if (appState.isWorking) {
                // Restore timer
                if (appState.timer) clearInterval(appState.timer);
                appState.timer = setInterval(updateTimer, 1000);
                
                // Restore UI
                if (elements.startBtn) {
                    elements.startBtn.disabled = appState.isOnBreak ? false : true;
                    elements.startBtn.textContent = appState.isOnBreak ? '‚ñ∂Ô∏è Reia Conducerea' : 'üöÄ Pornit...';
                }
                if (elements.breakBtn) {
                    elements.breakBtn.disabled = appState.isOnBreak;
                    if (!appState.isOnBreak) elements.breakBtn.classList.remove('pulse');
                }
                if (elements.stopBtn) elements.stopBtn.disabled = false;
                if (elements.nextBreak) elements.nextBreak.style.display = appState.isOnBreak ? 'none' : 'block';
                
                updateTimer();
            }
        } catch (e) {
            console.error('Restore working state error:', e);
            // Reset on error
            appState.isWorking = false;
            appState.isOnBreak = false;
            storage.remove('appState');
        }
    }

    function saveSessions() {
        try {
            storage.set('sessions', appState.sessions);
        } catch (e) {
            console.warn('Save sessions error:', e);
        }
    }

    function loadSessions() {
        try {
            const savedSessions = storage.get('sessions');
            if (savedSessions && Array.isArray(savedSessions)) {
                appState.sessions = savedSessions;
            }
        } catch (e) {
            console.warn('Load sessions error:', e);
        }
    }

    // Statistics
    function getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    function updateWeeklyStats() {
        try {
            const weekStart = getWeekStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);

            const weeklySessions = appState.sessions.filter(session => {
                const sessionDate = new Date(session.startTime);
                return sessionDate >= weekStart && sessionDate < weekEnd;
            });

            const weeklyHours = weeklySessions.reduce((sum, session) => sum + (session.totalDuration || 0), 0);
            const weeklyDriving = weeklySessions.reduce((sum, session) => sum + (session.drivingTime || 0), 0);
            const weeklyBreaks = weeklySessions.reduce((sum, session) => sum + (session.breaks || []).filter(b => b.end).length, 0);

            // Update UI
            const weeklyHoursEl = document.getElementById('weeklyHours');
            const weeklyDaysEl = document.getElementById('weeklyDays');
            const weeklyDrivingEl = document.getElementById('weeklyDriving');
            const weeklyBreaksEl = document.getElementById('weeklyBreaks');
            const totalSessionsEl = document.getElementById('totalSessions');
            const averageSessionEl = document.getElementById('averageSession');

            if (weeklyHoursEl) weeklyHoursEl.textContent = formatHours(weeklyHours) + 'h';
            if (weeklyDaysEl) weeklyDaysEl.textContent = weeklySessions.length;
            if (weeklyDrivingEl) weeklyDrivingEl.textContent = formatHours(weeklyDriving) + 'h';
            if (weeklyBreaksEl) weeklyBreaksEl.textContent = weeklyBreaks;

            if (totalSessionsEl) totalSessionsEl.textContent = appState.sessions.length;
            
            const avgSession = appState.sessions.length > 0 
                ? appState.sessions.reduce((sum, s) => sum + (s.totalDuration || 0), 0) / appState.sessions.length 
                : 0;
            if (averageSessionEl) averageSessionEl.textContent = formatHours(avgSession) + 'h';
        } catch (e) {
            console.error('Update weekly stats error:', e);
        }
    }

    function updateHistory() {
        try {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (appState.sessions.length === 0) {
                historyList.innerHTML = '<p style="color: #9ca3af; text-align: center;">Nu existƒÉ sesiuni √Ænregistrate</p>';
                return;
            }

            historyList.innerHTML = appState.sessions.slice(0, 20).map(session => {
                const breakCount = (session.breaks || []).filter(b => b.end).length;
                const totalBreakTime = (session.breaks || [])
                    .filter(b => b.end)
                    .reduce((sum, b) => sum + (b.duration || 0), 0);

                const startDate = new Date(session.startTime);
                const endDate = new Date(session.endTime);

                return `
                    <div class="history-item">
                        <div class="time">
                            ${startDate.toLocaleDateString('ro-RO')} 
                            ${startDate.toLocaleTimeString('ro-RO', {hour: '2-digit', minute: '2-digit'})} - 
                            ${endDate.toLocaleTimeString('ro-RO', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <div class="duration">
                            Total: ${formatTime(session.totalDuration || 0)} | 
                            Conducere: ${formatTime(session.drivingTime || 0)} | 
                            Pauze: ${breakCount} (${formatTime(totalBreakTime)})
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            console.error('Update history error:', e);
        }
    }

    // Export/Import
    function exportData() {
        try {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                sessions: appState.sessions
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `truck-driver-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error('Export error:', e);
            showError('Eroare la exportul datelor');
        }
    }

    function exportCSV() {
        try {
            const headers = ['Data', 'Ora Start', 'Ora Sfarsit', 'Durata Totala (h)', 'Timp Conducere (h)', 'Numar Pauze', 'Timp Pauze (h)'];
            
            const rows = appState.sessions.map(session => {
                const startDate = new Date(session.startTime);
                const endDate = new Date(session.endTime);
                const breakCount = (session.breaks || []).filter(b => b.end).length;
                const totalBreakTime = (session.breaks || []).filter(b => b.end).reduce((sum, b) => sum + (b.duration || 0), 0);

                return [
                    startDate.toLocaleDateString('ro-RO'),
                    startDate.toLocaleTimeString('ro-RO'),
                    endDate.toLocaleTimeString('ro-RO'),
                    formatHours(session.totalDuration || 0),
                    formatHours(session.drivingTime || 0),
                    breakCount,
                    formatHours(totalBreakTime)
                ];
            });

            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `truck-driver-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error('Export CSV error:', e);
            showError('Eroare la exportul CSV');
        }
    }

    function importData() {
        try {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.sessions && Array.isArray(data.sessions)) {
                        appState.sessions = [...data.sessions, ...appState.sessions];
                        saveSessions();
                        updateWeeklyStats();
                        updateHistory();
                        alert(`Import reu»ôit! ${data.sessions.length} sesiuni importate.`);
                    } else {
                        alert('Format invalid de fi»ôier!');
                    }
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    alert('Eroare la citirea fi»ôierului!');
                }
                
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        } catch (e) {
            console.error('Import error:', e);
            showError('Eroare la importul datelor');
        }
    }

    function clearAllData() {
        try {
            if (confirm('Sigur vrei sƒÉ »ôtergi toate datele? AceastƒÉ ac»õiune nu poate fi anulatƒÉ!')) {
                appState.sessions = [];
                storage.remove('sessions');
                storage.remove('appState');
                updateWeeklyStats();
                updateHistory();
                alert('Toate datele au fost »ôterse!');
            }
        } catch (e) {
            console.error('Clear data error:', e);
            showError('Eroare la »ôtergerea datelor');
        }
    }

    // Event listeners
    function setupEventListeners() {
        try {
            // Navigation tabs
            elements.navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    switchTab(targetTab);
                });
            });

            // Work control buttons
            if (elements.startBtn) {
                elements.startBtn.addEventListener('click', function() {
                    if (appState.isOnBreak) {
                        resumeWork();
                    } else {
                        startWork();
                    }
                });
            }

            if (elements.breakBtn) {
                elements.breakBtn.addEventListener('click', startBreak);
            }

            if (elements.stopBtn) {
                elements.stopBtn.addEventListener('click', stopWork);
            }

            // Export/Import buttons
            const exportBtn = document.getElementById('exportBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');
            const clearBtn = document.getElementById('clearBtn');

            if (exportBtn) exportBtn.addEventListener('click', exportData);
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportCSV);
            if (importBtn) importBtn.addEventListener('click', () => importFile.click());
            if (importFile) importFile.addEventListener('change', importData);
            if (clearBtn) clearBtn.addEventListener('click', clearAllData);

        } catch (e) {
            console.error('Setup event listeners error:', e);
        }
    }

    // Initialize app
    function initApp() {
        try {
            console.log('Ini»õializarea aplica»õiei...');
            
            // Cache DOM elements
            cacheElements();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load data
            loadSessions();
            loadAppState();
            
            // Switch to saved tab
            switchTab(appState.currentTab);
            
            // Update displays
            updateWeeklyStats();
            updateHistory();

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().catch(e => {
                    console.warn('Notification permission error:', e);
                });
            }
            
            console.log('Aplica»õia a fost ini»õializatƒÉ cu succes');
        } catch (e) {
            console.error('Init app error:', e);
            showError('Eroare la ini»õializarea aplica»õiei');
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        try {
            if (appState.timer) {
                clearInterval(appState.timer);
            }
            if (appState.isWorking || appState.isOnBreak) {
                saveAppState();
            }
        } catch (e) {
            console.error('Cleanup error:', e);
        }
    });

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }

    // Disable service worker to prevent caching issues
    console.log('Aplica»õia PWA pentru »ôoferi de camion - versiune stabilƒÉ');
</script>
```

</body>
</html>